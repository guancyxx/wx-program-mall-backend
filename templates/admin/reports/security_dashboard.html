{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .report-section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #007bff;
    }
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    .stat-label {
        color: #6c757d;
        margin-top: 5px;
    }
    .security-score {
        font-size: 3em;
        font-weight: bold;
        text-align: center;
        margin: 20px 0;
    }
    .score-excellent { color: #28a745; }
    .score-good { color: #ffc107; }
    .score-warning { color: #fd7e14; }
    .score-critical { color: #dc3545; }
    .risk-item {
        background: #f8f9fa;
        border-left: 4px solid;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
    }
    .risk-high { border-left-color: #dc3545; background: #f8d7da; }
    .risk-medium { border-left-color: #ffc107; background: #fff3cd; }
    .risk-low { border-left-color: #28a745; background: #d4edda; }
    .log-entry {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .log-entry.security-event {
        border-left: 3px solid #dc3545;
    }
    .log-entry.admin-action {
        border-left: 3px solid #ffc107;
    }
    .log-entry.login-event {
        border-left: 3px solid #28a745;
    }
    .notification-item {
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid;
    }
    .notification-error { border-left-color: #dc3545; background: #f8d7da; }
    .notification-warning { border-left-color: #ffc107; background: #fff3cd; }
    .table-responsive {
        overflow-x: auto;
    }
    .export-buttons {
        margin: 20px 0;
    }
    .export-buttons a {
        margin-right: 10px;
        padding: 8px 16px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ title }}</h1>
    
    <!-- Security Score -->
    <div class="report-section">
        <h2>Security Score</h2>
        <div class="security-score 
            {% if security_summary.security_score >= 90 %}score-excellent
            {% elif security_summary.security_score >= 75 %}score-good
            {% elif security_summary.security_score >= 60 %}score-warning
            {% else %}score-critical{% endif %}">
            {{ security_summary.security_score }}/100
        </div>
        <div style="text-align: center; color: #6c757d;">
            {% if security_summary.security_score >= 90 %}
                Excellent - Your system security is in great shape
            {% elif security_summary.security_score >= 75 %}
                Good - Minor security issues detected
            {% elif security_summary.security_score >= 60 %}
                Warning - Some security concerns need attention
            {% else %}
                Critical - Immediate security review required
            {% endif %}
        </div>
    </div>
    
    <!-- Security Summary -->
    <div class="report-section">
        <h2>Security Overview (Last 7 Days)</h2>
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-value">{{ security_summary.total_events }}</div>
                <div class="stat-label">Total Security Events</div>
            </div>
            <div class="stat-card" style="border-left-color: #28a745;">
                <div class="stat-value" style="color: #28a745;">{{ security_summary.login_events }}</div>
                <div class="stat-label">Successful Logins</div>
            </div>
            <div class="stat-card" style="border-left-color: #dc3545;">
                <div class="stat-value" style="color: #dc3545;">{{ security_summary.failed_logins }}</div>
                <div class="stat-label">Failed Login Attempts</div>
            </div>
            <div class="stat-card" style="border-left-color: #ffc107;">
                <div class="stat-value" style="color: #ffc107;">{{ security_summary.admin_actions }}</div>
                <div class="stat-label">Admin Actions</div>
            </div>
        </div>
        
        <div class="stat-grid">
            <div class="stat-card" style="border-left-color: #fd7e14;">
                <div class="stat-value" style="color: #fd7e14;">{{ security_summary.suspicious_activities }}</div>
                <div class="stat-label">Suspicious Activities</div>
            </div>
            <div class="stat-card" style="border-left-color: #e83e8c;">
                <div class="stat-value" style="color: #e83e8c;">{{ security_summary.privilege_escalations }}</div>
                <div class="stat-label">Privilege Escalation Attempts</div>
            </div>
            <div class="stat-card" style="border-left-color: #6f42c1;">
                <div class="stat-value" style="color: #6f42c1;">{{ security_summary.rate_limit_violations }}</div>
                <div class="stat-label">Rate Limit Violations</div>
            </div>
        </div>
    </div>
    
    <!-- Security Risks -->
    {% if security_risks %}
    <div class="report-section">
        <h2>Top Security Risks</h2>
        {% for risk in security_risks %}
        <div class="risk-item risk-{{ risk.risk_level|lower }}">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">{{ risk.type|title }}</h4>
                    <div style="color: #6c757d; font-size: 0.9em;">
                        User: {{ risk.user }} | IP: {{ risk.ip_address }} | 
                        {{ risk.timestamp|date:"M d, Y H:i" }}
                    </div>
                    <div style="margin-top: 10px;">{{ risk.details }}</div>
                </div>
                <span style="background: 
                    {% if risk.risk_level == 'HIGH' %}#dc3545
                    {% elif risk.risk_level == 'MEDIUM' %}#ffc107
                    {% else %}#28a745{% endif %};
                    color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">
                    {{ risk.risk_level }}
                </span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Active Security Notifications -->
    {% if active_notifications %}
    <div class="report-section">
        <h2>Active Security Notifications</h2>
        {% for notification in active_notifications %}
        <div class="notification-item notification-{{ notification.notification_type }}">
            <h4 style="margin: 0 0 10px 0;">{{ notification.title }}</h4>
            <div>{{ notification.message|linebreaks }}</div>
            <div style="color: #6c757d; font-size: 0.8em; margin-top: 10px;">
                {{ notification.created_at|date:"M d, Y H:i" }} | Priority: {{ notification.get_priority_display }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Recent Audit Logs -->
    <div class="report-section">
        <h2>Recent Security Events</h2>
        <div style="max-height: 400px; overflow-y: auto;">
            {% for log in recent_logs %}
            <div class="log-entry 
                {% if log.action in 'SUSPICIOUS_ACTIVITY,PRIVILEGE_ESCALATION,BRUTE_FORCE_ATTEMPT' %}security-event
                {% elif log.action == 'ADMIN_ACTION' %}admin-action
                {% elif log.action in 'LOGIN,LOGOUT' %}login-event{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>{{ log.get_action_display|default:log.action }}</strong>
                        {% if log.user %}by {{ log.user.username }}{% endif %}
                        {% if log.model_name %}- {{ log.model_name }}{% endif %}
                        {% if log.object_repr %}: {{ log.object_repr }}{% endif %}
                    </div>
                    <div style="color: #6c757d; font-size: 0.8em;">
                        {{ log.created_at|date:"M d H:i" }}
                    </div>
                </div>
                {% if log.message %}
                <div style="margin-top: 5px; color: #6c757d; font-size: 0.9em;">
                    {{ log.message }}
                </div>
                {% endif %}
                {% if log.ip_address %}
                <div style="margin-top: 5px; color: #6c757d; font-size: 0.8em;">
                    IP: {{ log.ip_address }}
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="log-entry">
                No recent security events found.
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Security Actions -->
    <div class="report-section">
        <h2>Security Actions</h2>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <a href="{% url 'admin:common_adminauditlog_changelist' %}" 
               style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">
                View All Audit Logs
            </a>
            <a href="{% url 'admin:common_systemnotification_changelist' %}" 
               style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">
                Manage Notifications
            </a>
            <a href="{% url 'admin:common_systemconfiguration_changelist' %}" 
               style="background: #ffc107; color: black; padding: 10px 20px; text-decoration: none; border-radius: 4px;">
                Security Settings
            </a>
            <a href="{% url 'admin:health_check' %}" 
               style="background: #17a2b8; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">
                System Health Check
            </a>
        </div>
    </div>
    
    <!-- Export Options -->
    <div class="report-section">
        <h2>Export Security Report</h2>
        <div class="export-buttons">
            <a href="{% url 'admin:report_export' 'security' 'csv' %}?days=7">Export to CSV</a>
            <a href="{% url 'admin:report_export' 'security' 'json' %}?days=7">Export to JSON</a>
        </div>
    </div>
</div>

<script>
// Auto-refresh security data every 5 minutes
setInterval(function() {
    fetch('{% url "admin:dashboard_api" %}?type=security_summary')
        .then(response => response.json())
        .then(data => {
            // Update security score if it has changed significantly
            const currentScore = {{ security_summary.security_score }};
            if (Math.abs(data.security_score - currentScore) > 5) {
                location.reload();
            }
        })
        .catch(error => console.log('Security data refresh failed:', error));
}, 300000); // 5 minutes
</script>
{% endblock %}