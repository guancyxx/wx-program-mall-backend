{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .report-section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #007bff;
    }
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    .stat-label {
        color: #6c757d;
        margin-top: 5px;
    }
    .alert-card {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }
    .alert-card.critical {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .table-responsive {
        overflow-x: auto;
    }
    .inventory-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .status-healthy { background: #d4edda; color: #155724; }
    .status-low { background: #fff3cd; color: #856404; }
    .status-critical { background: #f8d7da; color: #721c24; }
    .export-buttons {
        margin: 20px 0;
    }
    .export-buttons a {
        margin-right: 10px;
        padding: 8px 16px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ title }}</h1>
    
    <!-- Inventory Summary -->
    <div class="report-section">
        <h2>Inventory Overview</h2>
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-value">{{ inventory_report.summary.total_products }}</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card" style="border-left-color: #28a745;">
                <div class="stat-value" style="color: #28a745;">{{ inventory_report.summary.active_products }}</div>
                <div class="stat-label">Active Products</div>
            </div>
            <div class="stat-card" style="border-left-color: #ffc107;">
                <div class="stat-value" style="color: #ffc107;">{{ low_stock_count }}</div>
                <div class="stat-label">Low Stock Items</div>
            </div>
            <div class="stat-card" style="border-left-color: #dc3545;">
                <div class="stat-value" style="color: #dc3545;">{{ out_of_stock_count }}</div>
                <div class="stat-label">Out of Stock</div>
            </div>
        </div>
        
        <div class="stat-grid">
            <div class="stat-card" style="border-left-color: #17a2b8;">
                <div class="stat-value" style="color: #17a2b8;">${{ inventory_report.summary.total_inventory_value|floatformat:2 }}</div>
                <div class="stat-label">Total Inventory Value</div>
            </div>
        </div>
    </div>
    
    <!-- Inventory Alerts -->
    {% if inventory_report.out_of_stock_products or inventory_report.low_stock_products %}
    <div class="report-section">
        <h2>Inventory Alerts</h2>
        
        {% if inventory_report.out_of_stock_products %}
        <div class="alert-card critical">
            <h4 style="margin: 0 0 10px 0; color: #721c24;">⚠️ Out of Stock Products ({{ inventory_report.out_of_stock_products|length }})</h4>
            <div style="max-height: 200px; overflow-y: auto;">
                {% for product in inventory_report.out_of_stock_products %}
                <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                    <strong>{{ product.gid }}</strong> - {{ product.name }} 
                    <span style="color: #6c757d;">({{ product.category }}) - ${{ product.price|floatformat:2 }} - Sold: {{ product.sold }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if inventory_report.low_stock_products %}
        <div class="alert-card">
            <h4 style="margin: 0 0 10px 0; color: #856404;">⚠️ Low Stock Products ({{ inventory_report.low_stock_products|length }})</h4>
            <div style="max-height: 200px; overflow-y: auto;">
                {% for product in inventory_report.low_stock_products %}
                <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                    <strong>{{ product.gid }}</strong> - {{ product.name }} 
                    <span style="color: #6c757d;">({{ product.category }}) - Stock: {{ product.inventory }} - ${{ product.price|floatformat:2 }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Category Breakdown -->
    <div class="report-section">
        <h2>Inventory by Category</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Products</th>
                                <th>Total Inventory</th>
                                <th>Total Value</th>
                                <th>Avg Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category, data in inventory_report.categories.items %}
                            <tr>
                                <td>{{ category }}</td>
                                <td>{{ data.product_count }}</td>
                                <td>{{ data.total_inventory }}</td>
                                <td>${{ data.total_value|floatformat:2 }}</td>
                                <td>${{ data.avg_price|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Product Performance -->
    <div class="report-section">
        <h2>Product Performance (Last 30 Days)</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Product ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Current Inventory</th>
                        <th>Period Sales</th>
                        <th>Period Revenue</th>
                        <th>Turnover Rate</th>
                        <th>Views</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in product_performance %}
                    <tr>
                        <td>{{ product.gid }}</td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.category }}</td>
                        <td>
                            {% if product.inventory <= 0 %}
                                <span class="inventory-status status-critical">{{ product.inventory }}</span>
                            {% elif product.inventory <= 10 %}
                                <span class="inventory-status status-low">{{ product.inventory }}</span>
                            {% else %}
                                <span class="inventory-status status-healthy">{{ product.inventory }}</span>
                            {% endif %}
                        </td>
                        <td>{{ product.period_sold }}</td>
                        <td>${{ product.period_revenue|floatformat:2 }}</td>
                        <td>{{ product.inventory_turnover }}x</td>
                        <td>{{ product.views }}</td>
                        <td>
                            {% if product.is_featured %}
                                <span style="color: #007bff;">Featured</span>
                            {% endif %}
                            {% if product.is_top %}
                                <span style="color: #28a745;">Top</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9">No product performance data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Export Options -->
    <div class="report-section">
        <h2>Export Report</h2>
        <div class="export-buttons">
            <a href="{% url 'admin:report_export' 'inventory' 'csv' %}">Export to CSV</a>
            <a href="{% url 'admin:report_export' 'inventory' 'json' %}">Export to JSON</a>
        </div>
    </div>
</div>

<script>
// Category Distribution Chart
const categoryData = {{ inventory_report.categories|safe }};
const categoryNames = Object.keys(categoryData);
const categoryValues = categoryNames.map(name => categoryData[name].total_value);

const categoryCtx = document.getElementById('categoryChart').getContext('2d');

new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: categoryNames,
        datasets: [{
            data: categoryValues,
            backgroundColor: [
                '#007bff', '#28a745', '#ffc107', '#dc3545', 
                '#17a2b8', '#6f42c1', '#fd7e14', '#20c997'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Inventory Value by Category'
            },
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}